<?xml version="1.0" encoding="utf-8" ?>

<project name="cananolab-deployer" default="deploy:cananolab-webapp" basedir=".">
	<description>
		This script contains tasks related to cananolab distribution and installation
	</description>

	<!-- Properties file related properties and tasks -->
	<property environment="env" />
	<!-- properties to overwrite any defined in other properties file-->
	<property file="local.properties" />
	<!-- The project.properties stores properties that are shared between both build.xml and deploy.xml. -->
	<property file="project.properties" />
	<if>
		<isset property="tier" />
		<then>
			<!-- if tier is defined, load tier specific properties for tier based installation -->
			<property file="${tier}.properties" />
			<echo message="loaded ${tier} tier properties."/>
		</then>
		<else>
			<!-- load properties for non-tiered installation -->
			<property file="deploy.properties" />
		</else>
	</if>
	<!-- Default properties if not in tier.properties or deploy.properties-->
	<property file="default.properties" />

	<!-- Generic properties -->
	<property name="ldap.authentication.enabled" value="false" />
	<property name="database.type" value="mysql" />
	<property name="jboss.server.dir" value="${jboss.server.dir}" />
	<property name="jboss.conf.dir" value="${jboss.server.dir}/conf" />
	<property name="jboss.deploy.dir" value="${jboss.server.dir}/deploy" />
	<property name="jboss.lib.dir" value="${jboss.server.dir}/lib" />

	<property name="log.dir" location="${basedir}/logs" />

	<target name="dist:cananolab-webapp:resources">
		<!--copy mysql-ds.xml and replace database connection info-->
		<copy overwrite="true" tofile="${common.dist.dir}/mysql-ds.xml" file="${common.dir}/resources/jboss-conf/mysql-ds.xml">
			<!-- replace tokens with values from build properties -->
			<filterset id="db.filterset">
				<filter token="database.url" value="${database.url}" />
				<filter token="database.user" value="${database.user}" />
				<filter token="database.password" value="${database.password}" />
			</filterset>
		</copy>
		<if>
			<!--if use LDAP authentication, replace ldap tokens from build properties -->
			<equals arg1="${ldap.authentication.enabled}" arg2="true" />
			<then>
				<copy overwrite="true" tofile="${common.dist.dir}/login-config.xml" file="${common.dir}/resources/jboss-conf/login-config-ldap.xml">
					<filterset>
						<filter token="ldap.host.url" value="${ldap.host.url}" />
						<filter token="ldap.searchable.base" value="${ldap.searchable.base}" />
						<filter token="ldap.userId.label" value="${ldap.userId.label}" />
					</filterset>
				</copy>
			</then>
			<!--if use database authentication, replace database tokens from build properties -->
			<else>
				<copy overwrite="true" tofile="${common.dist.dir}/login-config.xml" file="${common.dir}/resources/jboss-conf/login-config-db.xml">
					<!-- replace tokens with values from build properties -->
					<filterset refid="db.filterset" />
				</copy>
			</else>
		</if>
		<!--copy upt.war -->
		<copy overwrite="true" todir="${common.dist.dir}" file="${common.dir}/resources/security/upt.war" />

		<!-- copy database jdbc driver -->
		<copy overwrite="true" todir="${common.dist.dir}" file="${lib.dir}/mysql-connector-java-5.0.7-bin.jar" />
	</target>

	<target name="deploy:cananolab-webapp">
		<!-- deploy WAR to JBOSS deploy location-->
		<copy todir="${jboss.deploy.dir}" overwrite="true">
			<fileset dir="${common.dist.dir}">
				<include name="upt.war" />
				<include name="${database.type}-ds.xml" />
			</fileset>
			<fileset dir="${cananolab-webapp.dist.dir}">
				<include name="*.war" />
			</fileset>
		</copy>
		<copy todir="${jboss.conf.dir}" overwrite="true" file="${common.dist.dir}/login-config.xml" />
		<copy todir="${jboss.lib.dir}" overwrite="true" file="${common.dist.dir}/mysql-connector-java-5.0.7-bin.jar" />
	</target>

	<target name="deploy:cananolab-grid">
		<!-- deploy WAR to JBOSS deploy direction -->
		<copy todir="${jboss.deploy.dir}" overwrite="true">
			<fileset dir="${cananolab-grid.dist.dir}">
				<include name="wsrf-canano.war" />
			</fileset>
		</copy>
		<!-- copy globus libs to JBoss lib direction -->
		<copy todir="${jboss.lib.dir}" overwrite="true">
			<fileset dir="${common.dist.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>
</project>
